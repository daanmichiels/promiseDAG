<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>promiseDAG</title>
    <script src="../promiseDAG.js"></script>
    <script src="promiseExamples.js"></script>
    <script>
        function getCenter(element) {
            var rect = element.getBoundingClientRect();
            var scrollLeft = window.pageXOffset;
            var scrollTop = window.pageYOffset;
            return {
                x: rect.left + scrollLeft + rect.width/2,
                y: rect.top + scrollTop + rect.height/2
            };
        }
        function createCanvas(width, height, containerId) {
            var canvas = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            canvas.setAttribute('width', '75em');
            canvas.setAttribute('height', '40em');
            document.body.appendChild(canvas);    
            return canvas;
        }
        function drawConnection(canvas, from, to) {
            var c1 = getCenter(from);
            var c2 = getCenter(to);
            var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', c1.x - canvas.getBoundingClientRect().left);
            line.setAttribute('y1', c1.y - canvas.getBoundingClientRect().top);
            line.setAttribute('x2', c2.x - canvas.getBoundingClientRect().left);
            line.setAttribute('y2', c2.y - canvas.getBoundingClientRect().top);
            line.setAttribute('stroke', "black");
            line.setAttribute('stroke-width', "0.1em");
            canvas.appendChild(line);
            return line;
        }
        function start() {
            var zero = document.getElementById("zero");
            var one = document.getElementById("one");
            var two = document.getElementById("two");
            var three = document.getElementById("three");
            var four = document.getElementById("four");
            var five = document.getElementById("five");
            var six = document.getElementById("six");
            var seven = document.getElementById("seven");

            var canvas = createCanvas();
            drawConnection(canvas, zero, two);
            drawConnection(canvas, one, two);
            drawConnection(canvas, two, three);
            drawConnection(canvas, two, four);
            drawConnection(canvas, one, four);
            drawConnection(canvas, three, five);
            drawConnection(canvas, four, five);
            drawConnection(canvas, four, six);
            drawConnection(canvas, three, seven);
            drawConnection(canvas, four, seven);

            callbacks = [
                () => {return sleep(zero, 1, 2000 * Math.random());},
                () => {return worker(one);},
                () => {return ajax(two, "assets/music-choice.txt");},
                () => {return confirm(three); },
                (url) => {return music(four, url);},
                () => {return sleep(five, 0.9, 3000 * Math.random());},
                () => {return sleep(six, 1, 2000 * Math.random());},
                () => {return sleep(seven, 0.9, 3000 * Math.random());},
            ];
            document.getElementById('go').addEventListener('click', function() {
                document.getElementById('go').style.visibility = 'hidden';
                promiseDAG(callbacks, [[], [], [0, 1], [2], [2, 1], [3, 4], [4], [3, 4]]).then(
                    (values) => { console.log('Succes!', values); },
                    (error) => { console.log('Fail...', error); }
                    );
            });
        }
        document.addEventListener("DOMContentLoaded", start);
    </script>
    <style>
        #dag div {
            border-radius: 0.5em;
            background-color: #00f;
            text-align: center;
            color: #fff;
            vertical-align: middle;
            padding: 0.5em;
            text-shadow: 0px 0px 0.3em black;
            box-shadow: 0px 0px 0.3em black;
        }
        audio, button {
            margin: 0.5em;
        }
        #dag div.pending {
            background-color: #ff0;
        }
        #dag div.resolved {
            background-color: #0a0;
        }
        #dag div.rejected {
            background-color: #f00;
        }
    </style>
</head>
<body>
    <h1>
        promiseDAG demo
    </h1>
    <p>
        This webpage demonstrates the use of promiseDAG visually.
        Below you'll find a directed acyclic graph (DAG).
        Each of the nodes represents a promise in the JavaScript sense.
    </p>
    <ul>
        <li>
            <em>Wait a bit</em>: these nodes just asynchronously sleep for a couple of seconds
            and then resolve
        </li>
        <li>
            <em>Wait and maybe fail</em>: these nodes asynchronously wait, and then resolve (90% chance) or reject (10% chance)
        </li>
        <li>
            <em>Load choice of music</em>: loads the file assets/music-choice.txt using an XMLHttpRequest
        </li>
        <li>
            <em>Continue?</em>: resolves if the user clicks "Yes", rejects if the user clicks "No"
        </li>
        <li>
            <em>Buffer music</em>: uses the url loaded by "Load choice of music" to load audio,
            and resolves when enough is buffered for playback (rejects if there's an error loading)
        </li>
    </ul>
    <p>
        The music used here was composed by Antonio Vivaldi and performed by
        John Harrison, Robert Turizziani and the WSU Chamber Players.
        It is licensed under the <a href="http://creativecommons.org/licenses/by-sa/1.0/deed.en">CC BY-SA 1.0</a>.
    </p>
    <p>
        You can start the DAG by clicking this button: <button id="go">Go!</button>
    </p>
    <div id="dag" style="position: relative;">
        <div id="zero" style="position: absolute; left: 1em; top: 1em;">
            Wait a bit
        </div>
        <div id="one" style="position: absolute; left: 1em; top: 11em;">
            Web worker
        </div>
        <div id="two" style="position: absolute; left: 11em; top: 7em;">
            Load choice of music
        </div>
        <div id="three" style="position: absolute; left: 25em; top: 1em;">
            Continue?
        </div>
        <div id="four" style="position: absolute; left: 21em; top: 14em;">
            Buffer music
        </div>
        <div id="five" style="position: absolute; left: 48em; top: 1em;">
            Wait and maybe fail
        </div>
        <div id="six" style="position: absolute; left: 51em; top: 11em;">
            Wait a bit
        </div>
        <div id="seven" style="position: absolute; left: 51em; top: 21em;">
            Wait and maybe fail
        </div>
    </div>
</body>
</html>
